<?php

/**
 * Defer.php aims to help you concentrate on web performance optimization.
 * (c) 2019-2023 SHIN Company https://shin.company
 *
 * PHP Version >=5.6
 *
 * @category  Web_Performance_Optimization
 * @package   AppSeeds
 * @author    Mai Nhut Tan <shin@shin.company>
 * @copyright 2019-2023 SHIN Company
 * @license   https://code.shin.company/defer.php/blob/master/LICENSE MIT
 * @link      https://code.shin.company/defer.php
 * @see       https://code.shin.company/defer.php/blob/master/README.md
 */

namespace AppSeeds\Resolvers;

use AppSeeds\Contracts\DeferNormalizable;

final class AnchorResolver extends DeferResolver implements DeferNormalizable
{
    /**
     * |-----------------------------------------------------------------------
     * | DeferNormalizable functions
     * |-----------------------------------------------------------------------.
     */
    /**
     * {@inheritdoc}
     */
    #[\ReturnTypeWillChange]
    public function normalize()
    {
        if ($this->node->hasAttribute('target') && !$this->node->hasAttribute('rel')) {
            // rel="noopener" prevents the new page from being able
            // to access the window.opener property
            // and ensures it runs in a separate process.
            $this->node->setAttribute('rel', 'noopener');
        }

        $href = $this->node->getAttribute('href');

        if (empty($href)) {
            $this->node->setAttribute('href', '#');
            $this->node->setAttribute('rel', 'nofollow');
        } elseif ($href == 'javascript:void(0);') {
            $this->node->setAttribute('href', 'javascript:;');
            $this->node->setAttribute('rel', 'nofollow');
        } elseif (preg_match('/^(\#|javascript)/i', $href)) {
            $this->node->setAttribute('rel', 'nofollow');
        }

        // Normalize the Node
        $this->node->normalize();
    }
}
